# SillyTavern 手机插件 📱

一个为 SillyTavern 设计的全功能手机界面模拟插件，提供丰富的应用生态和智能交互体验。

## 🚀 功能概览

### 📱 核心特性
- **仿真手机界面**：完整的iOS风格手机界面，支持拖拽和触摸操作
- **智能上下文监听**：实时监听SillyTavern事件，自动同步聊天数据
- **多应用生态**：9个功能完整的应用，覆盖社交、购物、任务管理等场景
- **数据解析系统**：强大的AI回复解析引擎，自动提取结构化数据
- **历史记录存储**：完整的用户行为和数据历史记录系统

## 📋 应用详解

### 💬 信息应用 (Messages)
**核心功能**：
- **聊天记录管理**：自动同步SillyTavern的所有聊天记录
- **朋友圈功能**：展示角色动态和互动内容
- **智能头像系统**：自动提取和显示角色头像
- **实时消息同步**：AI回复后自动更新，无需手动刷新
- **群聊支持**：完整的群聊消息展示和管理

**技术特点**：
- 使用DOM观察器实时监听消息变化
- 支持消息结构统一化处理
- 智能识别发送者和接收者

### 🛒 购物应用 (Shop)
**核心功能**：
- **商品浏览**：展示AI生成的商品信息
- **购物车管理**：添加、删除、修改商品数量
- **订单处理**：生成订单并发送到SillyTavern
- **余额管理**：自动计算和更新用户余额
- **购买历史**：记录所有购买行为

**数据格式**：
```
[商品|商品名称|价格|类型|描述]
[购买|商品名称|数量|总价]
```

### 📋 任务应用 (Task)
**核心功能**：
- **任务列表管理**：显示可接受、已接受、已完成的任务
- **任务状态跟踪**：自动解析AI回复中的任务状态变化
- **奖励系统**：处理任务完成后的奖励发放
- **点数计算**：实时计算用户任务点数

**数据格式**：
```
[任务|任务ID|任务名称|描述|发布者|奖励]
[接受任务|任务ID|任务名称|描述|发布者|奖励]
[完成任务|任务ID|任务名称|奖励]
```

### 🗣️ 论坛应用 (Forum)
**核心功能**：
- **帖子浏览**：展示论坛帖子和回复
- **发帖功能**：用户可以发布新帖子
- **互动系统**：点赞、回复、分享功能
- **第二API支持**：支持外部论坛API集成

**技术特点**：
- 支持iframe嵌入外部论坛页面
- 智能解析论坛数据格式
- 实时更新帖子状态

### 👁️ 微博应用 (Weibo)
**核心功能**：
- **微博浏览**：展示微博动态和热搜
- **发布微博**：用户可以发布动态
- **互动功能**：点赞、转发、评论
- **热搜榜单**：显示当前热门话题

### 🎬 直播应用 (Live)
**核心功能**：
- **直播间列表**：显示当前开播的直播间
- **观看直播**：进入直播间观看内容
- **弹幕互动**：发送弹幕和礼物
- **第二API支持**：支持外部直播平台API

**数据格式**：
```
[直播|直播间名称|主播用户名|直播类别|观看人数]
[弹幕|用户名|弹幕内容]
[礼物|用户名|礼物名称|数量]
```

### 🎒 背包应用 (Backpack)
**核心功能**：
- **物品管理**：展示用户拥有的所有物品
- **物品分类**：按类型自动分类物品
- **使用物品**：支持物品使用和消耗
- **数量统计**：实时显示物品数量

**数据格式**：
```
[背包|物品名称|物品类型|描述|数量]
[使用物品|物品名称|使用对象|使用方式|数量]
```

### 🔌 API应用 (API)
**核心功能**：
- **API接口管理**：管理各种外部API连接
- **数据同步**：与外部服务进行数据同步
- **接口测试**：测试API连接状态
- **配置管理**：管理API密钥和配置

**设计特色**：
- 支持多种API协议和格式

### ⚙️ 设置应用 (Settings)
**核心功能**：
- **界面配置**：自定义手机界面外观
- **背景设置**：更换应用背景图片
- **功能开关**：控制各种功能的启用状态
- **数据管理**：清理缓存和重置设置

## 🔧 核心技术特性

### 🎯 拖拽功能
- **通用拖拽系统**：支持手机按钮和界面框架的拖拽
- **智能边界检测**：防止拖拽超出屏幕范围
- **触摸优化**：完美支持PC端和移动端操作
- **点击保护**：确保拖拽不影响正常点击功能

### 👂 上下文监听
- **实时事件监听**：监听SillyTavern的所有关键事件
- **智能防抖机制**：避免频繁更新造成性能问题
- **多重检测机制**：DOM观察器 + 事件监听器 + 定时检查
- **自动同步**：AI回复后自动更新相关应用数据

### 🌐 第二API支持
- **论坛API**：支持外部论坛系统集成
- **直播API**：支持外部直播平台数据获取
- **数据格式统一**：自动转换不同API的数据格式
- **错误处理**：完善的API调用错误处理机制

### 💾 历史记录存储
- **本地存储**：使用localStorage保存用户数据
- **数据持久化**：应用状态和用户行为完整记录
- **智能清理**：自动清理过期和无效数据
- **备份恢复**：支持数据导出和导入功能

### 🔍 数据解析系统
- **智能解析引擎**：自动识别AI回复中的结构化数据
- **多格式支持**：支持任务、商品、背包、直播等多种数据格式
- **容错处理**：对格式错误的数据进行智能修复
- **实时更新**：解析完成后立即更新相应应用

## 📦 安装使用

### 安装步骤
1. 将插件文件夹放置到 SillyTavern 的扩展目录
2. 重启 SillyTavern 或刷新页面
3. 插件会自动加载并在页面右下角显示手机按钮

### 使用方法
1. **启动手机界面**：点击右下角的手机按钮
2. **拖拽操作**：长按手机按钮或状态栏可拖拽移动
3. **应用切换**：点击应用图标进入对应功能
4. **返回主屏**：点击应用内的返回按钮

## 🔧 开发说明

### 文件结构
```
mobile/
├── index.js                 # 主入口文件
├── manifest.json           # 插件配置文件
├── mobile-phone.js         # 手机界面核心逻辑
├── mobile-phone.css        # 手机界面样式
├── drag-helper.js          # 拖拽功能实现
├── apps/                   # 应用模块目录
│   ├── data-extractor.js   # 数据提取器
│   ├── context-watcher.js  # 上下文监听器
│   ├── message-app.js      # 信息应用
│   ├── shop-app.js         # 购物应用
│   ├── task-app.js         # 任务应用
│   ├── backpack-app.js     # 背包应用
│   └── ...                 # 其他应用文件
└── styles/                 # 样式文件目录
    ├── main.css            # 主样式文件
    └── ...                 # 各应用专用样式
```

### 扩展开发
- **模块化设计**：每个应用独立开发，便于维护
- **统一API接口**：所有应用遵循相同的接口规范
- **事件驱动架构**：基于事件系统实现应用间通信
- **插件化扩展**：支持第三方开发者添加新应用

## 📄 许可证

本项目采用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。

## 🔍 SillyTavern事件监听数据解析系统

### 核心监听机制
- **DOM变异观察器**：监听聊天区域HTML结构变化
- **SillyTavern事件系统**：监听内置事件（消息发送、接收、渲染等）
- **定时轮询检查**：每秒检查消息数量变化作为兜底机制
- **流式传输检测**：特殊处理AI流式回复过程

### 数据解析流程
1. **事件触发**：检测到新消息或上下文变化
2. **数据提取**：从DOM中提取消息内容和元数据
3. **格式解析**：识别特定格式的数据标签
4. **结构化处理**：转换为应用可用的数据结构
5. **应用通知**：通知相关应用更新显示

### 支持的数据格式
```javascript
// 任务格式
[任务|ID|名称|描述|发布者|奖励]
[接受任务|ID|名称|描述|发布者|奖励]
[完成任务|ID|名称|奖励]

// 商品格式
[商品|名称|价格|类型|描述]
[购买|商品名称|数量|总价]

// 背包格式
[背包|物品名称|类型|描述|数量]
[使用物品|物品名称|使用对象|使用方式|数量]

// 直播格式
[直播|直播间名称|主播用户名|类别|观看人数]
[弹幕|用户名|弹幕内容]
[礼物|用户名|礼物名称|数量]

// 论坛格式
[帖子|标题|作者|内容|时间|点赞数]
[回复|帖子ID|作者|内容|时间]

// 好友格式
[好友id|好友名称|QQ号码]
```

## 🎯 高级功能特性

### 智能防抖机制
- **私聊模式**：800ms延迟，确保消息完整性
- **群聊模式**：1500ms延迟，处理复杂群聊场景
- **流式传输**：特殊处理AI流式回复，避免中断更新

### 性能优化策略
- **懒加载**：应用按需加载，减少初始化时间
- **内存管理**：自动清理无用数据，防止内存泄漏
- **缓存机制**：智能缓存常用数据，提升响应速度
- **异步处理**：所有耗时操作异步执行，不阻塞UI

### 错误处理机制
- **容错解析**：对格式错误的数据进行智能修复
- **降级处理**：关键功能失效时提供备用方案
- **错误上报**：详细的错误日志和调试信息
- **自动恢复**：检测到异常后自动尝试恢复

## 🛠️ 故障排除

### 常见问题
1. **手机按钮不显示**
   - 检查插件是否正确安装
   - 确认SillyTavern已完全加载
   - 查看浏览器控制台错误信息

2. **应用数据不更新**
   - 检查上下文监听器是否正常工作
   - 确认AI回复格式是否正确
   - 尝试手动刷新应用

3. **拖拽功能异常**
   - 检查DragHelper是否正确加载
   - 确认没有其他脚本冲突
   - 尝试重新初始化拖拽功能

### 调试模式
在浏览器控制台中启用调试：
```javascript
// 启用全局调试
window.DEBUG_MOBILE_PHONE = true;

// 启用特定应用调试
window.DEBUG_MESSAGE_APP = true;
window.DEBUG_TASK_APP = true;
window.DEBUG_SHOP_APP = true;
```

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个项目！

### 贡献指南
1. Fork 本项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 📞 支持与反馈

如果您在使用过程中遇到问题或有改进建议，请：
- 提交 GitHub Issue
- 查看项目文档
- 参与社区讨论

---

**享受你的智能手机体验！** 📱✨

*让SillyTavern变得更加生动有趣！*
